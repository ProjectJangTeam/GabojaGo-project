<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitcamp.gabojago.dao.JangSoReviewDao">

    <!-- 자바 객체의 프로퍼티와 컬럼 이름을 연결 -->
    <resultMap type="jangSoReview" id="jangSoReviewMap">
        <result column="PRVNO" property="prvno"/>
        <result column="CONT" property="cont"/>
        <result column="RECONO" property="recono"/>
        <result column="PLNO" property="plno"/>
        <result column="PLNAME" property="plname"/>
<<<<<<< HEAD
<!--        <result column="JANGSO" property="jangSo"/>-->

        <collection property="jangSoReviewAttachedFiles" resultMap="jangSoReviewAttachedFile">
            <id column="RECOFNO" property="recofno"/>
            <result column="FILEPATH" property="filepath"/>
        </collection>
    </resultMap>

    <resultMap type="jangSoReviewAttachedFile" id="jangSoReviewAttachedFile">
        <id column="RECOFNO" property="recofno"/>
        <result column="FILEPATH" property="filepath"/>
        <result column="PRVNO" property="prvno"/>
=======

        <collection property="attachedFiles" ofType="jangSoReviewAttachedFile">
            <id column="recofno" property="recofno"/>
            <result column="filepath" property="filepath"/>
            <result column="fname" property="fname"/>
        </collection>

    </resultMap>

    <resultMap type="jangSoReviewAttachedFile" id="attachedFileMap">
        <id column="recofno" property="recofno"/>
        <result column="prvno" property="prvno"/>
        <result column="path" property="filepath"/>
        <result column="fname" property="fname"/>
>>>>>>> feat-recom-gu2
    </resultMap>

    <select id="jangSoReviewList" resultMap="jangSoReviewMap">
        select
            jsr.cont, jsr.plno, js.plname
        from
            jang_so_review jsr, jang_so js
        where
            jsr.recono = #{value}
            and jsr.plno = js.plno
    </select> <!-- 나중에 장소 테이블 추가해야함 -->

<<<<<<< HEAD
    <insert id="jangSoReviewAdd" parameterType="jangSoReview"
            useGeneratedKeys="true" keyColumn="prvno" keyProperty="pprvno">
=======
    <select id="attachedFileList" resultMap="attachedFileMap">
        select
        jsr.cont, jsr.plno, js.plname
        from
        jang_so_review jsr, jang_so js
        where
        jsr.recono = #{value}
        and jsr.plno = js.plno
    </select>

    <insert id="jangSoReviewAdd" parameterType="jangSoReview">
>>>>>>> feat-recom-gu2
                insert into jang_so_review(cont, recono, plno)
                values
        <foreach collection="jangSoReview" separator=",">
            (#{cont}, (select recono from jang_so_recommendation order by recono desc limit 1) ,2)
        </foreach>

    </insert>

    <insert id="jangSoReviewInsertFiles" parameterType="jangSoReviewAttachedFile">
        insert into jang_so_review_file(path, prvno, fname)
        values
        <foreach collection="jangSoReviewAttachedFiles" item="file" separator=",">
            (#{jangSoReview.filepath},#{jangSoReview.prvno}, #{jangSoReview.fname})
        </foreach>
    </insert>


    <select id="findFileByNo" resultMap="jangSoReviewAttachedFile">
        select
        recofno,
        path,
        prvno
        from
        jang_so_review_file
        where
        recofno = #{value}
    </select>

    <select id="findFilesByJangSoReview" resultMap="jangSoReviewAttachedFile">
        select
        recofno,
        path,
        prvno
        from
        jang_so_review_file
        where
        prvno = #{value}
    </select>


</mapper>